def options(opt):
  pass

def configure(conf):
  pass


def make_ml_machine(bld, name, libraries = ''):
  server_source = name + '_main.cpp'
  bld.program(
    source = server_source,
    target = 'juba' + name,
    includes = '.',
    use = libraries + ' jubaconverter jubatus_framework'
    )

  if bld.env.HAVE_ZOOKEEPER_H:
    keeper_source = name + '_keeper.cpp'
    bld.program(
      source = keeper_source,
      target = 'juba' + name + '_keeper',
      includes = '.',
      use = 'jubatus_framework'
      )

  bld.program(
    source = name + '_test.cpp',
    target = name + '_test',
    includes = '.',
    use = libraries + ' PFICOMMON jubaconverter jubatus_framework'
    )


def build(bld):

  # new code starts
  framework_source = 'server_util.cpp'
  if bld.env.HAVE_ZOOKEEPER_H:
    framework_source +=  ' mixer.cpp'

  bld.shlib(
    source = framework_source,
    target = 'jubatus_framework',
    includes = '.',
    use = 'PFICOMMON jubacommon MSGPACK GLOG'
    )

  #new recommender
  #new regression

  #new classifier
  classifier_sources = 'classifier_impl.cpp classifier_serv.cpp server_util.cpp'
  if bld.env.HAVE_ZOOKEEPER_H:
    classifier_sources +=  ' mixer.cpp'
  bld.program(
    source = classifier_sources,
    target = 'jubaclassifier',
    includes = '.',
    use = 'PFICOMMON jubacommon MSGPACK GLOG MPIO jubaclassifier jubaconverter jubastorage MSGPACK-RPC'
    )
  bld.program(
    source = 'classifier_keeper.cpp server_util.cpp',
    target = 'jubaclassifier_keeper',
    includes = '.',
    use = 'PFICOMMON jubacommon MSGPACK GLOG MSGPACK_RPC MPIO'
    )
  bld.program(
    features = 'gtest',
    source = 'classifier_test.cpp',
    target = 'classifier_test',
    use = 'MSGPACK-RPC',
    )

  n = bld.path.get_bld().make_node('test_input')
  n.mkdir()
  bld(rule = 'cp ${SRC} ${TGT}',
      source = bld.path.ant_glob('test_input/*'),
      target = n)

  bld.install_files('${PREFIX}/include/jubatus/server',
                    [
                     'classifier_types.hpp',
                     'client.hpp',
                     ])
